<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ask Your Zotero Library</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
  <style>
    body { max-width: 960px; margin: auto; padding: 1rem; }
    .card { transition: transform .1s; }
    .card:hover { transform: scale(1.02); }
    #app { display: none; }
  </style>
</head>
<body>

  <header class="text-center mb-4">
    <h1 class="display-5">üìö Ask Your Zotero Library</h1>
    <p class="text-muted">Filter by type, then search titles & abstracts.</p>
  </header>

  <!-- LOADING SPINNER -->
  <div id="loading" class="d-flex justify-content-center align-items-center my-5">
    <div class="spinner-border" role="status"><span class="visually-hidden">Loading‚Ä¶</span></div>
    <span class="ms-2">Loading your library‚Ä¶</span>
  </div>

  <!-- APP UI -->
  <div id="app">
    <div class="row mb-4 g-2">
      <div class="col-md-4">
        <label for="typeFilter" class="form-label">Filter by type</label>
        <select id="typeFilter" class="form-select">
          <option value="">All types</option>
          <option value="journalArticle">Journal Article</option>
          <option value="newspaperArticle">News Article</option>
          <option value="report">Report</option>
          <option value="webpage">Webpage</option>
        </select>
      </div>
      <div class="col-md-8 input-group">
        <input
          type="search"
          id="searchBar"
          class="form-control"
          placeholder="Search your library‚Ä¶"
          aria-label="Search"
        />
        <button id="searchBtn" class="btn btn-primary">Search</button>
      </div>
    </div>

    <div id="results" class="row row-cols-1 row-cols-md-2 g-4" aria-live="polite"></div>
  </div>

  <!-- Fuse.js -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

  <!-- Inline app script with logs & fallback -->
  <script>
  (async function() {
    console.log('üîç Script start');
    const serverURL     = 'https://zotero-proxy-1.onrender.com/zotero';
    const userID        = '6928802';
    const apiKey        = 'r7REcrUUJVF5BkmNfwDkxwqQ';
    const collectionKey = 'DVF2ZBSK';

    let allItems = [], fuse;

    // Fallback: unstick UI after 5s
    setTimeout(() => {
      console.warn('‚ö†Ô∏è Fallback: showing app after 5s');
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display     = 'block';
    }, 5000);

    // Fetch & filter Zotero items
    async function fetchLibrary() {
      console.log('‚ñ∂Ô∏è fetchLibrary start');
      let items = [], start = 0, pageSize = 100, more = true;
      while (more) {
    const url = serverURL
  + '?userID='        + encodeURIComponent(userID)
  + '&apiKey='        + encodeURIComponent(apiKey)
  + '&collectionKey=' + encodeURIComponent(collectionKey)
  + '&limit='         + pageSize
  + '&start='         + start;
        console.log('   fetching', url);
        const res = await fetch(url);
        console.log('   status', res.status);
        if (!res.ok) break;
        const data = await res.json();
        items = items.concat(data);
        if (data.length < pageSize) more = false;
        else start += pageSize;
      }
      console.log('‚úÖ fetchLibrary got', items.length, 'raw items');
      const filtered = items.filter(i =>
        i.data.itemType !== 'attachment' &&
        i.data.itemType !== 'note'
      );
      console.log('‚úÖ filtered to', filtered.length, 'items');
      return filtered;
    }

    // Render helper
    function renderResults(items) {
      console.log('‚ñ∂Ô∏è renderResults', items.length);
      const c = document.getElementById('results');
      c.innerHTML = '';
      if (!items.length) {
        c.innerHTML = '<div class="col"><p>No results.</p></div>';
        return;
      }
      items.forEach(item => {
        const { title, abstractNote, creators, date, url } = item.data;
        const authors = creators?.map(c => c.lastName).join(', ') || '';
        const year    = date?.split('-')[0] || '';
        const col = document.createElement('div');
        col.className = 'col';
        col.innerHTML = `
          <article class="card h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">
                <a href="${url||'#'}" target="_blank" rel="noopener">${title||'No title'}</a>
              </h5>
              <h6 class="card-subtitle mb-2 text-muted">
                ${authors}${year? ' ('+year+')':''}
              </h6>
              <p class="card-text flex-grow-1">${abstractNote||''}</p>
            </div>
          </article>`;
        c.appendChild(col);
      });
    }

    // Apply type filter + fuzzy search
    function applyFilters() {
      console.log('‚ñ∂Ô∏è applyFilters');
      const type  = document.getElementById('typeFilter').value;
      const query = document.getElementById('searchBar').value.trim();
      let pool = type
        ? allItems.filter(i => i.data.itemType === type)
        : allItems.slice();
      if (query) {
        console.log('   fuzzy searching for', query);
        pool = fuse.search(query).map(r => r.item);
      }
      renderResults(pool);
    }

    try {
      allItems = await fetchLibrary();
      // Initialize Fuse
      fuse = new Fuse(allItems, {
        keys: [
          { name: 'data.title',        weight: 0.5 },
          { name: 'data.abstractNote', weight: 0.4 },
          { name: 'data.creators',     weight: 0.1 }
        ],
        threshold: 0.3
      });
      renderResults(allItems);

      // Bind controls
      document.getElementById('searchBtn').addEventListener('click', applyFilters);
      document.getElementById('searchBar')
              .addEventListener('keypress', e => { if (e.key==='Enter') applyFilters(); });
      document.getElementById('typeFilter')
              .addEventListener('change', applyFilters);
    } catch (err) {
      console.error('‚ùå Error:', err);
      document.getElementById('results').innerHTML =
        '<div class="col"><p class="text-danger">Failed to load library.</p></div>';
    } finally {
      console.log('‚ñ∂Ô∏è setup done, showing app');
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display     = 'block';
    }
  })();
  </script>
</body>
</html>
