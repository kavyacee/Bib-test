<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ask Your Zotero Library</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  />
  <style>
    body { max-width: 960px; margin: auto; padding: 1rem; }
    .card { transition: transform .1s; }
    .card:hover { transform: scale(1.02); }
    #app { display: none; }
  </style>
</head>
<body>

  <header class="text-center mb-4">
    <h1 class="display-5">ðŸ“š Ask Your Zotero Library</h1>
    <p class="text-muted">Filter by type, then search titles & abstracts.</p>
  </header>

  <!-- LOADING SPINNER -->
  <div id="loading" class="d-flex justify-content-center align-items-center my-5">
    <div class="spinner-border" role="status"><span class="visually-hidden">Loadingâ€¦</span></div>
    <span class="ms-2">Loading your libraryâ€¦</span>
  </div>

  <!-- APP UI -->
  <div id="app">
    <div class="row mb-4 g-2">
      <div class="col-md-4">
        <label for="typeFilter" class="form-label">Filter by type</label>
        <select id="typeFilter" class="form-select">
          <option value="">All types</option>
          <option value="journalArticle">Journal Article</option>
          <option value="newspaperArticle">News Article</option>
          <option value="report">Report</option>
          <option value="webpage">Webpage</option>
        </select>
      </div>
      <div class="col-md-8 input-group">
        <input
          type="search"
          id="searchBar"
          class="form-control"
          placeholder="Search your libraryâ€¦"
          aria-label="Search"
        />
        <button id="searchBtn" class="btn btn-primary">Search</button>
      </div>
    </div>

    <div id="results" class="row row-cols-1 row-cols-md-2 g-4" aria-live="polite">
      <!-- results will appear here -->
    </div>
  </div>

  <!-- Fuse.js -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

  <!-- Inline app script with guaranteed spinner hide -->
  <script>
  (async function() {
    console.log('INIT START');
    const serverURL     = 'https://zotero-proxy-1.onrender.com/zotero';
    const userID        = '6928802';
    const apiKey        = 'r7REcrUUJVF5BkmNfwDkxwqQ';
    const collectionKey = 'DVF2ZBSK';

    let allItems = [], fuse;

    async function fetchLibrary() {
      let items = [], start = 0, pageSize = 100, more = true;
      while (more) {
        const url = `${serverURL}?userID=${userID}&apiKey=${apiKey}` +
                    `&collectionKey=${collectionKey}&limit=${pageSize}&start=${start}`;
        console.log('FETCH', url);
        const res = await fetch(url);
        console.log('STATUS', res.status);
        if (!res.ok) break;
        const data = await res.json();
        items = items.concat(data);
        if (data.length < pageSize) more = false;
        else start += pageSize;
      }
      return items.filter(i =>
        i.data.itemType !== 'attachment' &&
        i.data.itemType !== 'note'
      );
    }

    function renderResults(items) {
      console.log('RENDER', items.length);
      const c = document.getElementById('results');
      c.innerHTML = '';
      if (!items.length) {
        c.innerHTML = '<div class="col"><p>No results.</p></div>';
        return;
      }
      items.forEach(item => {
        const { title, abstractNote, creators, date, url } = item.data;
        const authors = creators?.map(c => c.lastName).join(', ') || '';
        const year    = date?.split('-')[0] || '';
        const col = document.createElement('div');
        col.className = 'col';
        col.innerHTML = `
          <article class="card h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">
                <a href="${url||'#'}" target="_blank" rel="noopener">${title||'No title'}</a>
              </h5>
              <h6 class="card-subtitle mb-2 text-muted">
                ${authors}${year ? ' ('+year+')' : ''}
              </h6>
              <p class="card-text flex-grow-1">${abstractNote||''}</p>
            </div>
          </article>`;
        c.appendChild(col);
      });
    }

    function applyFilters() {
      console.log('FILTER');
      const type  = document.getElementById('typeFilter').value;
      const query = document.getElementById('searchBar').value.trim();
      let pool = type
        ? allItems.filter(i => i.data.itemType === type)
        : allItems.slice();
      if (query) {
        pool = fuse.search(query).map(r => r.item);
      }
      renderResults(pool);
    }

    async function initApp() {
      allItems = await fetchLibrary();
      console.log('LOADED ITEMS', allItems.length);

      fuse = new Fuse(allItems, {
        keys: [
          { name: 'data.title',        weight: 0.5 },
          { name: 'data.abstractNote', weight: 0.4 },
          { name: 'data.creators',     weight: 0.1 }
        ],
        threshold: 0.3
      });

      renderResults(allItems);

      document.getElementById('searchBtn')
              .addEventListener('click', applyFilters);
      document.getElementById('searchBar')
              .addEventListener('keypress', e => { if (e.key==='Enter') applyFilters(); });
      document.getElementById('typeFilter')
              .addEventListener('change', applyFilters);

      console.log('INIT DONE');
    }

    // Run initApp() but never wait more than 5s
    try {
      await Promise.race([
        initApp(),
        new Promise(res => setTimeout(res, 5000))
      ]);
    } catch (e) {
      console.error('INIT ERROR', e);
    } finally {
      // Always hide spinner and show UI
      console.log('SHOW UI');
      document.getElementById('loading').style.display = 'none';
      document.getElementById('app').style.display     = 'block';
    }
  })();
  </script>
</body>
</html>
